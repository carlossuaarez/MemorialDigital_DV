<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorial Digital - Jard√≠n de Paz</title>
    <script src="https://components.digitalvalue.es/lib/mithril.min.js"></script>
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/1600/11d915/leaf.png"> <!-- favicon -->
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Lora:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

</head>

<body>
    <script>
        const DB = "memorial_db";

        var State = {
            deceased: {
                name: "",
                birth: "",
                death: "",
                photo: "https://pro.campus.sanofi/.imaging/mte/portal/256/dam/Portal/Spain/articulos/dislipemia/whats-next-2024/perfil.png/jcr:content/perfil.png",
                bio: "",
                gallery: [],
                messages: []
            },
            modalImage: null,
            newAuthor: "",
            newMessage: "",
            isAdmin: false,
            inputPin: "",
            showAdminPanel: false,
            velas: 0,
            toasts: [],
            dialog: { show: false, title: "", message: "", onConfirm: null, isPrompt: false, promptValue: "" }
        };

        function fetchData() {
            // 1. CARGAR PERFIL (ID 1)
            m.request({
                method: "GET",
                url: `sqlite.php/rdb/${DB}/perfil`
            })
                .then(function (res) {
                    if (res && res.items && res.items.length > 0) {
                        // Buscamos espec√≠ficamente el ID 1 entre los items
                        var dbData = res.items.find(function (i) { return i.id == 1; }) || res.items[0];

                        State.deceased.name = dbData.name || "";
                        State.deceased.birth = dbData.birth || "";
                        State.deceased.death = dbData.death || "";
                        State.deceased.bio = dbData.bio || "";
                        State.deceased.photo = dbData.photo || State.deceased.photo;
                        m.redraw();
                    }
                }).catch(function (e) { console.error("Error Perfil:", e); });

            // 2. CARGAR GALER√çA
            m.request({
                method: "GET",
                url: `sqlite.php/rdb/${DB}/fotos`
            })
                .then(function (res) {
                    State.deceased.gallery = (res && res.items) ? res.items : [];
                    m.redraw();
                }).catch(function (e) { console.error("Error Fotos:", e); });

            // 3. CARGAR TESTIMONIOS
            m.request({
                method: "GET",
                url: `sqlite.php/rdb/${DB}/testimonios`
            })
                .then(function (res) {
                    State.deceased.messages = (res && res.items) ? res.items : [];
                    m.redraw();
                }).catch(function (e) { console.error("Error Testimonios:", e); });
        }

        // Ejecutar carga inicial
        fetchData();

        // --- FUNCI√ìN: GUARDAR PERFIL EN DB ---
        function updateProfile(field, value) {
            // Actualizaci√≥n visual inmediata
            State.deceased[field] = value;

            // Objeto con los datos. Incluimos el ID para que el backend sepa cu√°l editar.
            var payload = { id: 1 };
            payload[field] = value;

            m.request({
                method: "PUT",
                url: `sqlite.php/rdb/${DB}/perfil/1`, // Ruta directa al registro 1
                body: payload
            })
                .then(function (res) {
                    showToast("üíæ Guardado");
                })
                .catch(function (err) {
                    // Si falla con /1, reintentamos a la ruta base (algunas configs lo prefieren as√≠)
                    m.request({
                        method: "PUT",
                        url: `sqlite.php/rdb/${DB}/perfil`,
                        body: payload
                    }).then(function () {
                        showToast("üíæ Guardado");
                    }).catch(function (err2) {
                        console.error("Fallo cr√≠tico al guardar:", err2);
                        showToast("‚ùå Error al guardar");
                    });
                });
        }

        function showToast(text) {
            var id = Date.now();
            State.toasts.push({ id: id, text: text });
            m.redraw();
            setTimeout(function () {
                State.toasts = State.toasts.filter(function (t) { return t.id !== id; });
                m.redraw();
            }, 3000);
        }

        function showConfirm(title, message, callback) {
            State.dialog = { show: true, title: title, message: message, onConfirm: callback, isPrompt: false };
        }

        function showPrompt(title, currentVal, callback) {
            State.dialog = { show: true, title: title, message: "", promptValue: currentVal, onConfirm: callback, isPrompt: true };
        }

        function deletePhoto(id) {
            showConfirm("¬øEliminar recuerdo?", "Esta acci√≥n no se puede deshacer.", function () {
                m.request({
                    method: "DELETE",
                    url: `sqlite.php/rdb/${DB}/fotos/${id}`
                }).then(function (res) {
                    showToast("Recuerdo eliminado");
                    fetchData();
                }).catch(function (err) {
                    showToast("Error al eliminar");
                });
            });
        }

        function deleteMessage(msgObj) {
            showConfirm("¬øEliminar testimonio?", "Esta acci√≥n ocultar√° permanentemente este mensaje.", function () {
                m.request({
                    method: "DELETE",
                    url: `sqlite.php/rdb/${DB}/testimonios/${msgObj.id}`
                }).then(function (res) {
                    showToast("Testimonio eliminado");
                    fetchData();
                }).catch(function (err) {
                    showToast("Error al eliminar");
                });
            });
        }

        // Subida de fotos para la galer√≠a
        function handleFileUpload(e) {
            var file = e.target.files[0];
            var autor = prompt("¬øQui√©n comparte este recuerdo?", "An√≥nimo");

            if (file) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    m.request({
                        method: "POST",
                        url: `sqlite.php/rdb/${DB}/fotos`,
                        body: {
                            src: event.target.result,
                            uploader_name: autor || "An√≥nimo"
                        }
                    })
                        .then(function (res) {
                            if (res && res.ok) {
                                showToast("üì∏ Foto guardada");
                                fetchData();
                            } else {
                                console.error("Error server:", res);
                                showToast("‚ùå Error al subir");
                            }
                        });
                };
                reader.readAsDataURL(file);
            }
        }

        // --- FUNCI√ìN: SUBIDA DE FOTO DE PERFIL ---
        function handleProfilePicUpload(e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    // Guardamos directamente en el campo 'photo' del perfil
                    updateProfile('photo', event.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function NotificationSystem() {
            return {
                view: function () {
                    return m("div", [
                        m(".toast-container", State.toasts.map(function (t) { return m(".toast", t.text); })),
                        State.dialog.show ? m(".dialog-overlay", [
                            m(".dialog-box", [
                                m("h3", State.dialog.title),
                                m("p", State.dialog.message),
                                State.dialog.isPrompt ? m("textarea.dialog-textarea", {
                                    rows: 4,
                                    value: State.dialog.promptValue,
                                    oninput: function (e) { State.dialog.promptValue = e.target.value; }
                                }) : null,
                                m(".dialog-buttons", [
                                    m("button.btn-action.btn-cancel", {
                                        onclick: function () { State.dialog.show = false; }
                                    }, "Cancelar"),
                                    m("button.btn-action", {
                                        onclick: function () {
                                            if (State.dialog.isPrompt) State.dialog.onConfirm(State.dialog.promptValue);
                                            else State.dialog.onConfirm();
                                            State.dialog.show = false;
                                        }
                                    }, "Aceptar")
                                ])
                            ])
                        ]) : null
                    ]);
                }
            };
        }

        function GalleryModal() {
            return {
                view: function () {
                    return m(".gallery-modal", {
                        class: State.modalImage ? "is-active" : "",
                        onclick: function () { State.modalImage = null; }
                    }, [
                        m("img.modal-img", {
                            src: State.modalImage
                        })
                    ]);
                }
            };
        }

        function AdminControl() {
            return {
                view: function () {
                    return m(".admin-wrapper", [
                        State.showAdminPanel ? m(".admin-panel-card", [
                            !State.isAdmin ? [
                                m("h5", "Acceso Familiar"),
                                m("input[type=password][placeholder=PIN]", {
                                    value: State.inputPin,
                                    oninput: function (e) { State.inputPin = e.target.value; }
                                }),
                                m("button.btn-action.btn-admin-login", {
                                    onclick: function () {
                                        if (State.inputPin === "1234") {
                                            State.isAdmin = true;
                                            State.inputPin = "";
                                            showToast("Modo editor activado");
                                        } else {
                                            showToast("PIN incorrecto");
                                        }
                                    }
                                }, "Entrar")
                            ] : [
                                m(".admin-status-tag", "EDITOR ACTIVO"),
                                m("button.btn-action.btn-admin-logout", {
                                    onclick: function () {
                                        State.isAdmin = false;
                                        State.showAdminPanel = false;
                                        showToast("Editor cerrado");
                                    }
                                }, "Cerrar Sesi√≥n")
                            ]
                        ]) : null,
                        m("button.btn-circle.btn-settings", {
                            onclick: function () { State.showAdminPanel = !State.showAdminPanel; }
                        }, State.showAdminPanel ? "√ó" : "‚öôÔ∏è")
                    ]);
                }
            }
        }

        function MemorialCard() {
            return {
                view: function () {
                    var p = State.deceased;
                    return m("div.container", [
                        m(".memorial-card.memorial-card-clean", [

                            // 1. PORTADA
                            m(".cover-photo.cover-photo-custom"),

                            // 2. GRID PRINCIPAL
                            m(".profile-grid", [

                                // --- COLUMNA IZQUIERDA ---
                                m(".profile-sidebar", [
                                    m(".profile-pic-container", [
                                        m("img.profile-pic.profile-pic-main", { src: p.photo }),
                                        State.isAdmin ? m("label.btn-edit-photo", [
                                            m("input[type=file][accept=image/*]", {
                                                style: "display: none;", // El √∫nico inline necesario para ocultar el input real
                                                onchange: handleProfilePicUpload
                                            }),
                                            "üì∑"
                                        ]) : null
                                    ]),

                                    m(".profile-sidebar-inner", [
                                        m(".name-row", [
                                            m("h1.name.name-text", p.name),
                                            State.isAdmin ? m("button.btn-circle.btn-edit-small", {
                                                onclick: function () { showPrompt("Editar Nombre", p.name, function (val) { updateProfile('name', val); }); }
                                            }, "‚úèÔ∏è") : null
                                        ]),

                                        m(".dates-row", [
                                            m("span", p.birth + " | " + p.death),
                                            State.isAdmin ? m("button.btn-circle.btn-edit-mini", {
                                                onclick: function () {
                                                    showPrompt("Fechas (Nacimiento | Partida)", p.birth, function (val) {
                                                        updateProfile('birth', val);
                                                        setTimeout(function () {
                                                            var nuevaMuerte = prompt("Fecha de Partida:", p.death);
                                                            if (nuevaMuerte) updateProfile('death', nuevaMuerte);
                                                        }, 500);
                                                    });
                                                }
                                            }, "‚úèÔ∏è") : null
                                        ]),

                                        m(".interaction-bar.interaction-bar-clean", [
                                            m(".interaction-inner", [
                                                m("button.btn-circle", { onclick: function () { State.velas++; showToast("üïØÔ∏è Homenaje enviado"); } }, "üïØÔ∏è"),
                                                m("button.btn-circle", {
                                                    onclick: function () {
                                                        navigator.clipboard.writeText(window.location.href).then(function () { showToast("üîó Enlace copiado"); });
                                                    }
                                                }, "üîó"),
                                                m("button.btn-circle", { onclick: function () { window.print(); } }, "üìÑ"),
                                                State.isAdmin ? m("button.btn-circle.btn-bio-edit", {
                                                    onclick: function () { showPrompt("Editar biograf√≠a", p.bio, function (nb) { updateProfile('bio', nb); }); }
                                                }, "‚úèÔ∏è Bio") : null
                                            ])
                                        ]),

                                        m(".bio-container", [
                                            m("span.quote-mark.quote-left", "‚Äú"),
                                            m("p.bio-text", p.bio),
                                            m("span.quote-mark.quote-right", "‚Äù")
                                        ])
                                    ])
                                ]),

                                // --- COLUMNA DERECHA ---
                                m(".main-content", [
                                    m("h3.section-title", [m("span", { style: "background: #fff; padding: 20px;" }, "Recuerdos")]),
                                    m(".gallery.gallery-clean", [
                                        p.gallery.map(function (imgData) {
                                            return m(".gallery-item", [
                                                m("img", { src: imgData.src, onclick: function () { State.modalImage = imgData.src; } }),
                                                m(".uploader-tag", "Subida por: " + (imgData.uploader_name || "An√≥nimo")),
                                                State.isAdmin ? m("button.btn-delete", { onclick: function () { deletePhoto(imgData.id); } }, "√ó") : null
                                            ]);
                                        }),

                                        m("label.gallery-item.gallery-add-card", [
                                            m("input[type=file][accept=image/*]", { style: "display: none;", onchange: handleFileUpload }),
                                            m("span.add-icon", "+"),
                                            m("span.add-text", "A√ëADIR FOTO")
                                        ]),
                                    ]),

                                    m("h3.section-title", [m("span", { style: "background: #fff; padding: 0 20px;" }, "Testimonios")]),
                                    m(".dedication-grid.dedication-grid-clean", p.messages.map(function (msg) {
                                        return m(".dedication-card.dedication-card-clean", [
                                            State.isAdmin ? m("button.btn-msg-delete", { onclick: function () { deleteMessage(msg); } }, "üóëÔ∏è") : null,
                                            m("p.message", msg.text),
                                            m("span.author", "‚Äî " + msg.author)
                                        ]);
                                    })),

                                    m("form.form-card.form-card-clean", {
                                        onsubmit: function (e) {
                                            e.preventDefault();
                                            if (State.newAuthor && State.newMessage) {
                                                let txt = State.newMessage.trim();
                                                if (txt) {
                                                    txt = txt.charAt(0).toUpperCase() + txt.slice(1);
                                                    txt = txt.replace(/\.\s*([a-z√±√°√©√≠√≥√∫])/gi, (m, l) => ". " + l.toUpperCase());
                                                    if (!/[.!?]$/.test(txt)) txt += ".";
                                                }
                                                m.request({
                                                    method: "POST",
                                                    url: `sqlite.php/rdb/${DB}/testimonios`,
                                                    body: { author: State.newAuthor, text: txt }
                                                }).then(function (res) {
                                                    if (res && res.ok) { showToast("‚ú® Mensaje publicado"); State.newAuthor = ""; State.newMessage = ""; fetchData(); }
                                                });
                                            }
                                        }
                                    }, [
                                        m("h4.form-title", "Dejar una dedicatoria"),
                                        m(".form-body", [
                                            m("input.input-clean", {
                                                placeholder: "Su nombre o relaci√≥n",
                                                value: State.newAuthor,
                                                oninput: function (e) { State.newAuthor = e.target.value; }
                                            }),
                                            m("textarea.textarea-clean", {
                                                placeholder: "Escriba su mensaje aqu√≠...",
                                                value: State.newMessage,
                                                oninput: function (e) { State.newMessage = e.target.value; }
                                            }),
                                            m("button.btn-action", "Publicar Testimonio")
                                        ])
                                    ])
                                ])
                            ])
                        ])
                    ]);
                }
            };
        }

        function Footer() {
            return {
                view: function () {
                    return m("footer.main-footer", [
                        m(".footer-grid", [
                            // Columna 1: Branding
                            m(".footer-column", [
                                m(".footer-branding", [
                                    m(".footer-logo-square", "G"),
                                    m("span.footer-brand-name", "GARDEN OF REMEMBRANCE")
                                ]),
                                m("p", "Lorem ipsum dolor sit amet consectetur adipisicing elit. Doloribus at obcaecati porro modi adipisci quod officia, similique necessitatibus inv")
                            ]),

                            // Columna 2: Enlaces
                            m(".footer-column", [
                                m("h4", "Navegaci√≥n"),
                                m("ul.footer-links", [
                                    m("li", "Centro de Ayuda"),
                                    m("li", "Lorem ipsum"),
                                    m("li", "Lorem")
                                ])
                            ]),

                            // Columna 3: Social
                            m(".footer-column", [
                                m("h4", "Redes Sociales"),
                                m(".social-icons", [
                                    m("a.social-icon", { href: "#" }, "Instagram"),
                                    m("a.social-icon", { href: "#" }, "Twitter"),
                                    m("a.social-icon", { href: "#" }, "Facebook")
                                ])
                            ])
                        ]),

                        // Copyright Bar
                        m(".copyright-bar", [
                            m("span", "¬© 2026 Garden Of Remembrance"),
                            m(".footer-legal-links", [
                                m("span", "Privacidad"),
                                m("span", "T√©rminos")
                            ])
                        ])
                    ])
                }
            }
        }

        function App() {
            return {
                view: function () {
                    return m("div", [
                        m("nav.header",
                            m("h2.nav-title", "GARDEN OF REMEMBRANCE")
                        ),
                        m(MemorialCard),
                        m(GalleryModal),
                        m(AdminControl),
                        m(NotificationSystem),
                        m(Footer),
                    ]);
                }
            };
        }

        m.mount(document.body, App);
    </script>
</body>

</html>